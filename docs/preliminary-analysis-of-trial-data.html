<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 8 Preliminary analysis of trial data | Genomic Prediction and Selection Manual</title>
<meta name="author" content="Marnin Wolfe">
<meta name="description" content="Context and Purpose: Upstream: Section 7 - quality control steps for genotypic data Downstream: Genomic prediction and related analyses. Inputs: Expected outputs:  8.1 One-stage or multi-stage? We...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 8 Preliminary analysis of trial data | Genomic Prediction and Selection Manual">
<meta property="og:type" content="book">
<meta property="og:url" content="https://wolfemd.github.io/GenomicSelectionManual/preliminary-analysis-of-trial-data.html">
<meta property="og:description" content="Context and Purpose: Upstream: Section 7 - quality control steps for genotypic data Downstream: Genomic prediction and related analyses. Inputs: Expected outputs:  8.1 One-stage or multi-stage? We...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 8 Preliminary analysis of trial data | Genomic Prediction and Selection Manual">
<meta name="twitter:description" content="Context and Purpose: Upstream: Section 7 - quality control steps for genotypic data Downstream: Genomic prediction and related analyses. Inputs: Expected outputs:  8.1 One-stage or multi-stage? We...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Genomic Prediction and Selection Manual</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Preamble</a></li>
<li><a class="" href="outline.html"><span class="header-section-number">2</span> Outline</a></li>
<li><a class="" href="using-this-manual.html"><span class="header-section-number">3</span> Using this manual</a></li>
<li><a class="" href="create_project.html"><span class="header-section-number">4</span> Create a (workflowR) project</a></li>
<li><a class="" href="download-training-data.html"><span class="header-section-number">5</span> Download training data</a></li>
<li><a class="" href="prepare-phenotype-data.html"><span class="header-section-number">6</span> Prepare phenotype data</a></li>
<li><a class="" href="prepare-genotypic-data.html"><span class="header-section-number">7</span> Prepare genotypic data</a></li>
<li><a class="active" href="preliminary-analysis-of-trial-data.html"><span class="header-section-number">8</span> Preliminary analysis of trial data</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/wolfemd/GenomicSelectionManual">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="preliminary-analysis-of-trial-data" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Preliminary analysis of trial data<a class="anchor" aria-label="anchor" href="#preliminary-analysis-of-trial-data"><i class="fas fa-link"></i></a>
</h1>
<ul>
<li><p><strong>Context and Purpose:</strong></p></li>
<li><p><strong>Upstream:</strong> Section <a href="prepare-genotypic-data.html#prepare-genotypic-data">7</a> - quality control steps for genotypic data</p></li>
<li><p><strong>Downstream:</strong> Genomic prediction and related analyses.</p></li>
<li><p><strong>Inputs:</strong></p></li>
<li><p><strong>Expected outputs:</strong></p></li>
</ul>
<div id="one-stage-or-multi-stage" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> One-stage or multi-stage?<a class="anchor" aria-label="anchor" href="#one-stage-or-multi-stage"><i class="fas fa-link"></i></a>
</h2>
<p>We often have very large, multi-year, multi-location, multi-trial-type (<strong>MET</strong>) datasets we use to train genomic prediction models. The number of plots can be in the range of 10- or even 100,000 plots with many thousands of unique genotypes observed in unbalanced fashion across heterogenous experimental designs. All that to say, the computational burden and level of expertise required to execute genomic prediction analyses directly on these data is very great.</p>
<p>For the sake of semi-automation and computational efficiency, the standard genomic prediction pipeline I have implemented for NextGen Cassava, which I demonstrate below, has two stages:</p>
<p><strong>Stage 1. Get BLUPs</strong></p>
<ul>
<li>
<p>Conduct preliminary analysis of the trial data <em>without</em> genomic relatedeness / marker-information.</p>
<p>Identify the best-fitting model for the data and potentially curate the raw data, removing outliers.</p>
</li>
<li><p>Fit mixed-model to <strong>MET</strong> data. Extract <strong><code>BLUPs</code></strong>, <strong><code>PEVs</code></strong> and variance components (<strong><code>VarComps</code></strong>). Compute de-regressed BLUPs (<strong><code>drgBLUPs</code></strong>) and weights (<strong><code>WTS</code></strong>) for “Stage 2.”</p></li>
</ul>
<p><strong>Stage 2. Cross-validation and genomic prediction</strong></p>
<p>Conduct weighted cross-validation and genomic prediction analyses using <strong><code>de-regressed BLUPs</code></strong> (alternative <strong><code>BLUEs</code></strong>) as the response variable and the weights from Stage 1. This effectively reduces the number of “observations” in the analysis to the number of unique genotypes (i.e. clones, inbred lines, etc.), leading to lower computational burden.</p>
<p><strong>Note of advice for single-stage analyses:</strong> I strongly recommend conducting preliminary analysis of the trial data <em>without</em> genomic relatedeness / marker-information. Ensure the model will converge, residuals look acceptable and otherwise assess the best fitting model <em>before</em> commiting to lengthy computationally intensive analyses. :)</p>
</div>
<div id="set-up-training-datasets" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Set-up training datasets<a class="anchor" aria-label="anchor" href="#set-up-training-datasets"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">phenos</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"output"</span>,<span class="st">"phenotypes_cleaned.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The pipeline version of this analysis will use the <code>TRUE/FALSE</code> values of <strong><code>CompleteBlocks</code></strong> and <strong><code>IncompleteBlocks</code></strong> ([Preliminary analysis of trial data][#detect_designs]).</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">phenos</span> <span class="op"><a href="https://gt.rstudio.com/reference/pipe.html">%&gt;%</a></span> 
     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">CompleteBlocks</span>,<span class="va">IncompleteBlocks</span>,<span class="va">locationName</span><span class="op">)</span> <span class="op"><a href="https://gt.rstudio.com/reference/pipe.html">%&gt;%</a></span> 
     <span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">locationName</span>,<span class="va">n</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 4</span>
<span class="co">#&gt;   CompleteBlocks IncompleteBlocks Ibadan Ubiaja</span>
<span class="co">#&gt;   &lt;lgl&gt;          &lt;lgl&gt;             &lt;int&gt;  &lt;int&gt;</span>
<span class="co">#&gt; 1 FALSE          TRUE                777     NA</span>
<span class="co">#&gt; 2 TRUE           FALSE                NA    125</span>
<span class="co">#&gt; 3 TRUE           TRUE                407    414</span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nestDesignsDetectedByTraits</span>
<span class="co">#&gt; function(indata,traits){</span>
<span class="co">#&gt;   indata %&lt;&gt;%</span>
<span class="co">#&gt;     select(programName,locationName,studyYear,TrialType,studyName,</span>
<span class="co">#&gt;            CompleteBlocks,IncompleteBlocks,</span>
<span class="co">#&gt;            yearInLoc,trialInLocYr,repInTrial,blockInRep,observationUnitDbId,</span>
<span class="co">#&gt;            germplasmName,FullSampleName,GID,all_of(traits),PropNOHAV) %&gt;%</span>
<span class="co">#&gt;     mutate(IncompleteBlocks=ifelse(IncompleteBlocks==TRUE,"Yes","No"),</span>
<span class="co">#&gt;            CompleteBlocks=ifelse(CompleteBlocks==TRUE,"Yes","No")) %&gt;%</span>
<span class="co">#&gt;     pivot_longer(cols = all_of(traits), names_to = "Trait", values_to = "Value") %&gt;%</span>
<span class="co">#&gt;     filter(!is.na(Value),</span>
<span class="co">#&gt;            !is.na(GID)) %&gt;%</span>
<span class="co">#&gt;     nest(MultiTrialTraitData=c(-Trait))</span>
<span class="co">#&gt;   return(indata)</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; &lt;bytecode: 0x7f9cc33e8198&gt;</span>
<span class="co">#&gt; &lt;environment: namespace:genomicMateSelectR&gt;</span></code></pre></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="prepare-genotypic-data.html"><span class="header-section-number">7</span> Prepare genotypic data</a></div>
<div class="next"><a href="references.html">References</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#preliminary-analysis-of-trial-data"><span class="header-section-number">8</span> Preliminary analysis of trial data</a></li>
<li><a class="nav-link" href="#one-stage-or-multi-stage"><span class="header-section-number">8.1</span> One-stage or multi-stage?</a></li>
<li><a class="nav-link" href="#set-up-training-datasets"><span class="header-section-number">8.2</span> Set-up training datasets</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/wolfemd/GenomicSelectionManual/blob/master/05-getBLUPs.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/wolfemd/GenomicSelectionManual/edit/master/05-getBLUPs.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Genomic Prediction and Selection Manual</strong>" was written by Marnin Wolfe. It was last built on 2022-01-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
